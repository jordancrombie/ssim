<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - SSIM Store</title>
  <link rel="stylesheet" href="/css/tailwind.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/" class="flex items-center space-x-2">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-lg flex items-center justify-center">
              <span class="text-white font-bold text-sm">S</span>
            </div>
            <span class="font-semibold text-gray-800">SSIM Store</span>
          </a>
        </div>
        <div class="flex items-center space-x-4">
          <a href="/store" class="text-gray-600 hover:text-gray-800">Store</a>
          <a href="/checkout" class="text-gray-600 hover:text-gray-800 relative">
            Cart
            <% if (cartCount > 0) { %>
            <span class="absolute -top-2 -right-2 bg-purple-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"><%= cartCount %></span>
            <% } %>
          </a>
          <% if (isAuthenticated) { %>
          <a href="/orders" class="text-gray-600 hover:text-gray-800">Orders</a>
          <a href="/auth/logout" class="text-gray-600 hover:text-gray-800">Logout</a>
          <% } else { %>
          <a href="/login" class="text-gray-600 hover:text-gray-800">Login</a>
          <% } %>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-4xl mx-auto py-12 px-4">
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 py-6">
        <h1 class="text-3xl font-bold text-white">Checkout</h1>
        <p class="text-purple-100 mt-1">Review your order and complete payment</p>
      </div>

      <div class="p-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
          <svg class="animate-spin h-8 w-8 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="text-gray-600 mt-4">Loading cart...</p>
        </div>

        <!-- Empty Cart State -->
        <div id="emptyState" class="hidden text-center py-12">
          <svg class="w-20 h-20 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
          <h2 class="text-xl font-semibold text-gray-800 mt-4">Your cart is empty</h2>
          <p class="text-gray-600 mt-2">Add some items to your cart to checkout</p>
          <a href="/store" class="inline-block mt-6 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition">
            Browse Store
          </a>
        </div>

        <!-- Cart Contents -->
        <div id="cartContents" class="hidden">
          <!-- Cart Items -->
          <div class="space-y-4 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Order Summary</h2>
            <div id="cartItems" class="divide-y divide-gray-100">
              <!-- Items will be inserted here -->
            </div>
          </div>

          <!-- Order Total -->
          <div class="bg-gray-50 rounded-xl p-6 mb-8">
            <div class="flex justify-between items-center text-lg">
              <span class="font-semibold text-gray-800">Total</span>
              <span id="cartTotal" class="text-2xl font-bold text-purple-600">$0.00</span>
            </div>
            <p class="text-sm text-gray-500 mt-2">Taxes calculated at checkout</p>
          </div>

          <!-- Authentication Required -->
          <% if (!isAuthenticated) { %>
          <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-8">
            <div class="flex items-start">
              <svg class="w-6 h-6 text-yellow-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <div>
                <h3 class="text-yellow-800 font-semibold">Login Required</h3>
                <p class="text-yellow-700 text-sm mt-1">Please log in to complete your purchase</p>
                <a href="/login" class="inline-block mt-3 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition">
                  Log In
                </a>
              </div>
            </div>
          </div>
          <% } else { %>
          <!-- Pay with BSIM Button -->
          <button
            id="payBankButton"
            onclick="initiatePayment('bank')"
            class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 px-6 rounded-xl font-semibold text-center hover:from-purple-700 hover:to-indigo-700 transition transform hover:scale-[1.02] flex items-center justify-center space-x-3"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
            </svg>
            <span>Pay with BSIM</span>
          </button>

          <% if (wsimEnabled) { %>
          <!-- Divider -->
          <div class="flex items-center my-4">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="mx-4 text-gray-400 text-sm">or</span>
            <div class="flex-grow border-t border-gray-200"></div>
          </div>

          <!-- Pay with Wallet Button -->
          <button
            id="payWalletButton"
            onclick="initiatePayment('wallet')"
            class="w-full bg-gradient-to-r from-violet-600 to-purple-600 text-white py-4 px-6 rounded-xl font-semibold text-center hover:from-violet-700 hover:to-purple-700 transition transform hover:scale-[1.02] flex items-center justify-center space-x-3"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            <span>Pay with Wallet</span>
          </button>
          <% } %>

          <p class="text-center text-sm text-gray-500 mt-4">
            You will be redirected to authorize payment
          </p>
          <% } %>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden mb-6">
          <div id="declinedError" class="hidden bg-orange-50 border border-orange-200 rounded-xl p-6">
            <div class="flex items-start">
              <svg class="w-6 h-6 text-orange-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <div class="flex-1">
                <h3 class="text-orange-800 font-semibold">Payment Declined</h3>
                <p id="declineReason" class="text-orange-700 text-sm mt-1"></p>
                <p class="text-orange-600 text-sm mt-2">Please try a different payment method.</p>
              </div>
            </div>
          </div>
          <div id="genericError" class="hidden bg-red-50 border border-red-200 rounded-xl p-6">
            <div class="flex items-start">
              <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div>
                <h3 class="text-red-800 font-semibold">Payment Error</h3>
                <p id="errorMessage" class="text-red-600 text-sm mt-1"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Back to Store -->
        <div class="mt-8 pt-6 border-t border-gray-200">
          <a href="/store" class="text-purple-600 hover:text-purple-700 font-medium flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Continue Shopping
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let cartData = null;

    async function loadCart() {
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const cartContents = document.getElementById('cartContents');
      const errorState = document.getElementById('errorState');

      try {
        const response = await fetch('/api/cart');
        cartData = await response.json();

        loadingState.classList.add('hidden');

        if (!cartData.items || cartData.items.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }

        // Render cart items
        const cartItemsContainer = document.getElementById('cartItems');
        cartItemsContainer.innerHTML = cartData.items.map(item => `
          <div class="flex items-center justify-between py-4">
            <div class="flex items-center space-x-4">
              <div class="w-16 h-16 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-lg flex items-center justify-center">
                <svg class="w-8 h-8 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-gray-800">${item.product.name}</h3>
                <p class="text-sm text-gray-500">Qty: ${item.quantity}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="font-semibold text-gray-800">${formatPrice(item.subtotal)}</p>
              <button onclick="removeItem('${item.productId}')" class="text-sm text-red-500 hover:text-red-700">Remove</button>
            </div>
          </div>
        `).join('');

        document.getElementById('cartTotal').textContent = cartData.formattedTotal;
        cartContents.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading cart:', error);
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        document.getElementById('genericError').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = 'Failed to load cart';
      }
    }

    function formatPrice(cents) {
      return new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: 'CAD',
      }).format(cents / 100);
    }

    async function removeItem(productId) {
      try {
        const response = await fetch(`/api/cart/remove/${productId}`, {
          method: 'DELETE',
        });

        if (response.ok) {
          loadCart();
        }
      } catch (error) {
        console.error('Error removing item:', error);
      }
    }

    async function initiatePayment(provider = 'bank') {
      const bankButton = document.getElementById('payBankButton');
      const walletButton = document.getElementById('payWalletButton');
      const activeButton = provider === 'wallet' ? walletButton : bankButton;

      if (activeButton) {
        activeButton.disabled = true;
        activeButton.innerHTML = `
          <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Processing...
        `;
      }

      try {
        // Create order and initiate payment with selected provider
        const response = await fetch('/payment/initiate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ provider }),
        });

        const data = await response.json();

        if (response.ok && data.redirectUrl) {
          // Redirect to auth for payment authorization
          window.location.href = data.redirectUrl;
        } else {
          throw new Error(data.error || 'Failed to initiate payment');
        }
      } catch (error) {
        console.error('Payment initiation error:', error);

        // Reset button
        if (activeButton) {
          activeButton.disabled = false;
          if (provider === 'wallet') {
            activeButton.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              <span>Pay with Wallet</span>
            `;
          } else {
            activeButton.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
              </svg>
              <span>Pay with BSIM</span>
            `;
          }
        }

        document.getElementById('errorState').classList.remove('hidden');
        document.getElementById('genericError').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    // Check for payment errors in URL
    function checkForErrors() {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      const reason = urlParams.get('reason');

      if (error) {
        const errorState = document.getElementById('errorState');
        errorState.classList.remove('hidden');

        if (error === 'payment_declined') {
          const declinedError = document.getElementById('declinedError');
          const declineReason = document.getElementById('declineReason');
          declinedError.classList.remove('hidden');
          declineReason.textContent = reason ? decodeURIComponent(reason) : 'Your payment was declined by the bank.';
        } else {
          const genericError = document.getElementById('genericError');
          const errorMessage = document.getElementById('errorMessage');
          genericError.classList.remove('hidden');

          if (error === 'payment_failed') {
            errorMessage.textContent = 'Payment processing failed. Please try again.';
          } else if (error === 'access_denied') {
            errorMessage.textContent = 'Payment was cancelled.';
          } else if (reason) {
            errorMessage.textContent = decodeURIComponent(reason);
          } else {
            errorMessage.textContent = 'An error occurred during payment. Please try again.';
          }
        }

        // Clear the URL params without refreshing the page
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // Load cart on page load
    loadCart();
    checkForErrors();
  </script>
</body>
</html>
